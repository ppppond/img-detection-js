require('dotenv').config();
// 1. à¸™à¸³à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸¡à¸·à¸­à¸•à¹ˆà¸²à¸‡à¹† à¹€à¸Šà¹ˆà¸™ express
const express = require('express');
const cors = require('cors');
const mongoose = require('mongoose');
const qcLog = require('./models/Qclog')

// 2. à¸ªà¸£à¹‰à¸²à¸‡à¸•à¸±à¸§à¹à¸—à¸™ server
const app = express();

// à¸•à¸±à¸§à¹à¸›à¸£à¸ˆà¸³à¹€à¸§à¸¥à¸²à¹à¸ˆà¹‰à¸‡à¹€à¸•à¸·à¸­à¸™à¸¥à¹ˆà¸²à¸ªà¸¸à¸”
let lastAlertTime = 0;
const COOLDOWN_TIME = 60 * 1000; // à¸•à¸±à¹‰à¸‡à¸„à¸¹à¸¥à¸”à¸²à¸§à¸™à¹Œà¹„à¸§à¹‰ 60 à¸§à¸´à¸™à¸²à¸—à¸µ (60,000 à¸¡à¸´à¸¥à¸¥à¸´à¸§à¸´à¸™à¸²à¸—à¸µ)

// à¸£à¸±à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸²à¸à¸«à¸™à¹‰à¸² web
// à¹ƒà¸Šà¹‰à¸‡à¸²à¸™ âœ¨ 2. à¸•à¸´à¸”à¸›à¸£à¸°à¸à¸²à¸¨à¹ƒà¸«à¹‰ à¸£à¸›à¸ . à¸£à¸¹à¹‰à¸§à¹ˆà¸² "à¸­à¸™à¸¸à¸à¸²à¸•à¹ƒà¸«à¹‰à¸—à¸¸à¸à¹€à¸§à¹‡à¸šà¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¡à¸²à¹„à¸”à¹‰à¹€à¸¥à¸¢ (à¹à¸ˆà¸à¸šà¸±à¸•à¸£ VIP)"
app.use(cors());
app.use(express.json())



// ðŸ•µï¸â€â™‚ï¸ à¸„à¸³à¸–à¸²à¸¡à¸—à¸µà¹ˆ 2: à¹€à¸›à¸´à¸”à¸›à¸£à¸°à¸•à¸¹à¸£à¸±à¸šà¸žà¸±à¸ªà¸”à¸¸ (GET à¸«à¸£à¸·à¸­ POST?)
// à¸«à¸™à¹‰à¸²à¸šà¹‰à¸²à¸™à¸à¸³à¸¥à¸±à¸‡à¸ˆà¸° "à¸ªà¹ˆà¸‡" à¸à¸¥à¹ˆà¸­à¸‡à¸žà¸±à¸ªà¸”à¸¸à¸¡à¸²à¹ƒà¸«à¹‰à¹€à¸£à¸² à¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆà¸¡à¸²à¸‚à¸­à¸«à¸™à¹‰à¸²à¹€à¸§à¹‡à¸š
// app.post('/api/qc-log', (req, res) => {
//     // ðŸ•µï¸â€â™‚ï¸ à¸„à¸³à¸–à¸²à¸¡à¸—à¸µà¹ˆ 3: à¹à¸à¸°à¹€à¸™à¸·à¹‰à¸­à¸«à¸²à¸­à¸­à¸à¸ˆà¸²à¸à¸à¸¥à¹ˆà¸­à¸‡
//     // à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¡à¸±à¸™à¸ˆà¸°à¸­à¸¢à¸¹à¹ˆà¹ƒà¸™ "à¸£à¹ˆà¸²à¸‡à¸à¸²à¸¢/à¹€à¸™à¸·à¹‰à¸­à¸«à¸²" à¸‚à¸­à¸‡ request
//     const data = req.body;

//     console.log('ðŸŽ à¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¹ˆà¸‡à¸¡à¸²à¸–à¸¶à¸‡à¹€à¸‹à¸´à¸£à¹Œà¸Ÿà¹€à¸§à¸­à¸£à¹Œ:', data);

//     // ðŸ•µï¸â€â™‚ï¸ à¸„à¸³à¸–à¸²à¸¡à¸—à¸µà¹ˆ 4: à¸•à¸­à¸šà¸à¸¥à¸±à¸šà¸«à¸™à¹‰à¸²à¸šà¹‰à¸²à¸™
//     // à¸•à¸­à¸šà¸à¸¥à¸±à¸šà¹€à¸›à¹‡à¸™à¸Ÿà¸­à¸£à¹Œà¹à¸¡à¸•à¸­à¸°à¹„à¸£à¸”à¸µà¸™à¹‰à¸²à¸²à¸² (j_ _ _)
//     res.json({
//         status: 'success',
//         message: 'à¹€à¸‹à¸´à¸£à¹Œà¸Ÿà¹€à¸§à¸­à¸£à¹Œà¹„à¸”à¹‰à¸£à¸±à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢'
//     });
// });

app.post('/api/qc-log', async (req, res) => {

    const data = req.body;
    console.log('ðŸŽ à¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¹ˆà¸‡à¸¡à¸²à¸–à¸¶à¸‡à¹€à¸‹à¸´à¸£à¹Œà¸Ÿà¹€à¸§à¸­à¸£à¹Œ:', data);

    // ðŸ•µï¸â€â™‚ï¸ à¸„à¸³à¸–à¸²à¸¡à¸—à¸µà¹ˆ 2: à¸™à¸³à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¡à¸²à¹ƒà¸ªà¹ˆ "à¹à¸¡à¹ˆà¸žà¸´à¸¡à¸žà¹Œ" (qcLog) à¸—à¸µà¹ˆà¹€à¸£à¸² import à¹„à¸§à¹‰à¸”à¹‰à¸²à¸™à¸šà¸™
    // à¸„à¸µà¸¢à¹Œà¹€à¸§à¸´à¸£à¹Œà¸”à¸ªà¸³à¸«à¸£à¸±à¸šà¸ªà¸£à¹‰à¸²à¸‡à¸ªà¸´à¹ˆà¸‡à¸‚à¸­à¸‡à¸Šà¸´à¹‰à¸™à¹ƒà¸«à¸¡à¹ˆ (Instance) à¹ƒà¸™ JavaScript à¸„à¸·à¸­à¸­à¸°à¹„à¸£à¸„à¸£à¸±à¸š?
    // (à¹ƒà¸šà¹‰: n _ _)
    const newLog = new qcLog({
        count: data.count,
        detectedClass: data.detectedClass
        // (timestamp à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¹ƒà¸ªà¹ˆ à¹€à¸žà¸£à¸²à¸°à¹€à¸£à¸²à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸² default à¹ƒà¸«à¹‰à¹€à¸›à¹‡à¸™à¹€à¸§à¸¥à¸²à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™à¹„à¸§à¹‰à¹à¸¥à¹‰à¸§)
    });

    // à¸ªà¸±à¹ˆà¸‡à¸£à¸­à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹‚à¸«à¸¥à¸”à¹ƒà¸«à¹‰à¹€à¸ªà¸£à¹‡à¸ˆà¸à¹ˆà¸­à¸™ à¹à¸¥à¸°à¸ªà¸±à¹ˆà¸‡à¸šà¸±à¸™à¸—à¸¶à¸
    await newLog.save();
    console.log('à¹€à¸­à¸²à¸‚à¸­à¸‡à¹€à¸‚à¹‰à¸² MongoDB à¸ªà¸³à¹€à¸£à¹‡à¸ˆà¹à¸¥à¹‰à¸§!');

    // à¸£à¸°à¸šà¸šà¹à¸ˆà¹‰à¸‡à¹€à¸•à¸·à¸­à¸™à¸„à¸§à¸²à¸¡à¸›à¸¥à¸­à¸”à¸ à¸±à¸¢ (Discord Webhook)
    // à¸ˆà¸³à¸™à¸§à¸™à¸„à¸™à¸—à¸µà¹ˆà¸™à¸±à¸šà¹„à¸”à¹‰ à¸–à¸¹à¸à¹€à¸à¹‡à¸šà¸­à¸¢à¸¹à¹ˆà¹ƒà¸™à¸žà¸±à¸ªà¸”à¸¸à¸Šà¸·à¹ˆà¸­ data
    if (data.count === 0) {

        // à¸”à¸¶à¸‡à¹€à¸§à¸¥à¸²à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™
        const currentTime = Date.now();

        // logic à¹€à¸Šà¹‡à¸„à¹€à¸§à¸¥à¸²à¸„à¸¹à¸¥à¸”à¸²à¸§à¸™à¹Œ
        if (currentTime - lastAlertTime > COOLDOWN_TIME) {
            console.log('âš ï¸ à¹à¸ˆà¹‰à¸‡à¹€à¸•à¸·à¸­à¸™: à¸žà¸™à¸±à¸à¸‡à¸²à¸™à¸—à¸´à¹‰à¸‡à¸ˆà¸¸à¸”à¸•à¸£à¸§à¸ˆ! à¸à¸³à¸¥à¸±à¸‡à¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¹€à¸‚à¹‰à¸² Discord...');

            // à¸£à¸µà¹€à¸‹à¹‡à¸—à¸à¸²à¸£à¸ˆà¸±à¸šà¹€à¸§à¸¥à¸² à¹€à¸•à¸·à¸­à¸™à¹€à¸ªà¸£à¹‡à¸ˆà¸›à¸¸à¹Šà¸š à¸•à¹‰à¸­à¸‡à¸£à¸µà¸šà¸ˆà¸”à¹„à¸§à¹‰à¸§à¹ˆà¸² "à¹€à¸•à¸·à¸­à¸™à¸„à¸£à¸±à¹‰à¸‡à¸¥à¹ˆà¸²à¸ªà¸¸à¸”à¸„à¸·à¸­à¹€à¸§à¸¥à¸²à¸™à¸µà¹‰"
            lastAlertTime = currentTime;

            // à¸¢à¸´à¸‡ API
            fetch(
                // à¸•à¸±à¸§à¸—à¸µà¹ˆà¹€à¸£à¸²à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸ªà¹ˆà¸‡à¸à¸²à¸£à¹à¸ˆà¹‰à¸‡à¹€à¸•à¸·à¸­à¸™à¹„à¸› à¹ƒà¸Šà¹‰ .env à¹€à¸žà¸·à¹ˆà¸­à¸„à¸§à¸²à¸¡à¸›à¸¥à¸­à¸”à¸ à¸±à¸¢
                process.env.DISCORD_WEBHOOK,
                { // à¸£à¸¹à¸›à¹à¸šà¸šà¸à¸²à¸£à¸ªà¹ˆà¸‡
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        content: "ðŸš¨ **à¹à¸­à¸”à¸¡à¸´à¸™à¸„à¸£à¸±à¸š! à¸žà¸™à¸±à¸à¸‡à¸²à¸™à¹„à¸¡à¹ˆà¸­à¸¢à¸¹à¹ˆà¸—à¸µà¹ˆà¸ˆà¸¸à¸”à¸•à¸£à¸§à¸ˆ QC à¸„à¸£à¸±à¸š!**"
                    })
                }
            ).catch(err => console.error('âŒ à¹à¸ˆà¹‰à¸‡à¹€à¸•à¸·à¸­à¸™ Discord à¸žà¸±à¸‡: ', err));
        } else {
            console.log('â³ (à¸•à¸´à¸”à¸„à¸¹à¸¥à¸”à¸²à¸§à¸™à¹Œ) à¸„à¸™à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸­à¸¢à¸¹à¹ˆ à¹à¸•à¹ˆà¸£à¸°à¸šà¸šà¸à¸±à¸™à¸ªà¹à¸›à¸¡à¸—à¸³à¸‡à¸²à¸™à¸­à¸¢à¸¹à¹ˆà¸„à¸£à¸±à¸š...');
        }
    }


    res.json({
        status: 'success',
        message: 'à¹€à¸‹à¸´à¸£à¹Œà¸Ÿà¹€à¸§à¸­à¸£à¹Œà¹„à¸”à¹‰à¸£à¸±à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢à¹à¸¥à¹‰à¸§'
    });
});

// à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸à¸²à¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ MongoDB à¹ƒà¸Šà¹‰ .env 
mongoose.connect(process.env.MONGO_CONNECT)
    .then(() => console.log('âœ… à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¸à¸²à¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ MongoDB à¸ªà¸³à¹€à¸£à¹‡à¸ˆ!'))
    .catch(err => console.error('âŒ à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­ MongoDB à¸¥à¹‰à¸¡à¹€à¸«à¸¥à¸§ (à¹€à¸›à¸´à¸”à¹‚à¸›à¸£à¹à¸à¸£à¸¡ DB à¸«à¸£à¸·à¸­à¸¢à¸±à¸‡?): ', err))

// 3. à¸ªà¸±à¹ˆà¸‡à¹€à¸›à¸´à¸”à¹€à¸‹à¸´à¸£à¹Œà¸Ÿà¹€à¸§à¸­à¸£à¹Œ (à¸­à¸¢à¹ˆà¸²à¸¥à¸·à¸¡à¸šà¸£à¸£à¸—à¸±à¸”à¸™à¸µà¹‰ à¸ªà¸³à¸„à¸±à¸à¸¡à¸²à¸!)
app.listen(process.env.PORT, () => {
    console.log('Server is running');
})