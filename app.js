/* file р╕Хр╕▒р╕зр╕Щр╕╡р╣Йр╕Ьр╕бр╕Ир╕░р╣Гр╕Вр╣Йр╣Гр╕Щр╕Бр╕▓р╕г setting р╕Др╣Ир╕▓р╕Хр╣Ир╕▓р╕Зр╣Ж 
р╣Ар╕Кр╣Ир╕Щ set camera р╕зр╕▓р╕З label р╣Ар╕кр╣Йр╕Щр╕Вр╕нр╕Ър╣Бр╕Ър╕Ъ automatic р╣Бр╕ер╣Йр╕зр╕Бр╣Зр╕Юр╕зр╕Бр╕Бр╕▓р╕гр╣Ар╕Ыр╕┤р╕Ф app */


// р╕нр╣Йр╕▓р╕Зр╕нр╕┤р╕З
const videoElement = document.getElementById('my-video');
const canvas = document.getElementById('my-canvas');

//р╕Др╕│р╕кр╕▒р╣Ир╕Зр╣Гр╕Щр╕Бр╕▓р╕гр╕лр╕вр╕┤р╕Ър╕Юр╕╣р╣Ир╕Бр╕▒р╕Щ 2 р╕бр╕┤р╕Хр╕┤ (р╕кр╕гр╣Йр╕▓р╕Зр╕Хр╕▒р╕зр╣Бр╕Ыр╕гр╕Юр╕╣р╣Ир╕Бр╕▒р╕Щ)
const ctx = canvas.getContext('2d');

// р╕Бр╕│р╕лр╕Щр╕Фр╕Хр╕▒р╕зр╣Бр╕Ыр╕г Global Variable
let currentCount = 0;

// function
async function startAI() {
    console.log('1. р╕Бр╕│р╕ер╕▒р╕Зр╣Ар╕Ыр╕┤р╕Фр╕Бр╕ер╣Йр╕нр╕З...')
    await setupCamera(); // р╕гр╕нр╣Гр╕лр╣Йр╕Бр╕ер╣Йр╕нр╕Зр╣Ар╕Ыр╕┤р╕Ф
    console.log('р╕Бр╕ер╣Йр╕нр╕Зр╕Юр╕гр╣Йр╕нр╕б');

    // р╕Ыр╕гр╕▒р╕Ър╕Вр╕Щр╕▓р╕Фр╣Гр╕лр╣Йр╣Ар╕Чр╣Ир╕▓р╕Бр╕▒р╕Ъ video
    canvas.width = videoElement.videoWidth;
    canvas.height = videoElement.videoHeight;

    // р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓р╕Юр╕╣р╣Ир╕Бр╕▒р╕Щ
    ctx.strokeStyle = 'red'; // р╣Ар╕кр╣Йр╕Щр╕кр╕╡р╣Бр╕Фр╕З
    ctx.lineWidth = 1; // р╕Др╕зр╕▓р╕бр╕Бр╕зр╣Йр╕▓р╕Зр╕Вр╕нр╕Зр╣Ар╕кр╣Йр╕Щ
    ctx.font = '18px Arail'; // р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓р╕Яр╕нр╕Щр╕Хр╣Мр╕кр╕│р╕лр╕гр╕▒р╕Ър╕Хр╕▒р╕зр╕лр╕Щр╕▒р╕Зр╕кр╕╖р╕н

    console.log('2. р╕Бр╕│р╕ер╕▒р╕Зр╣Вр╕лр╕ер╕Ф AI');
    // р╣Вр╕лр╕ер╕Ф model COCO-SSD р╕бр╕▓р╣Ар╕Хр╕гр╕╡р╕вр╕бр╣Др╕зр╣Й
    const model = await cocoSsd.load();

    detectFrame(videoElement, model)
}

async function setupCamera() {
    // 1. р╕Вр╕нр╕кр╕Хр╕гр╕╡р╕б video р╕Ир╕▓р╕Бр╕Бр╕ер╣Йр╕нр╕З web cam
    const stream = await navigator.mediaDevices.getUserMedia({ video: true }); // р╕Фр╕╢р╕З input р╕нр╕╕р╕Ыр╕Бр╕гр╕Ур╣М

    // 2. р╣Ар╕нр╕▓ stream р╕Чр╕╡р╣Ир╣Др╕Фр╣Йр╕Ир╕▓р╕Б camera р╣Др╕Ыр╕Ьр╕╣р╕Бр╕Бр╕▒р╕Ъ video element
    // srcObject р╣Гр╕Кр╣Йр╕кр╕│р╕лр╕гр╕▒р╕Ър╕кр╣Ир╕З MediaStream р╣Вр╕Фр╕вр╕Хр╕гр╕З (р╕Хр╣Ир╕▓р╕Зр╕Ир╕▓р╕Б src р╕Чр╕╡р╣Ир╣Гр╕Кр╣Йр╕Бр╕▒р╕Ъ URL р╕Вр╕нр╕Зр╣Др╕Яр╕ер╣М)
    videoElement.srcObject = stream;

    // 3. р╕гр╕н video р╕Юр╕гр╣Йр╕нр╕бр╣Ар╕ер╣Ир╕Щ
    return new Promise((resolve) => {
        // onloadmetadata р╕Др╕╖р╕н event р╕Фр╕▓р╕зр╣Вр╕лр╕ер╕Ф metadata р╕Ир╕░р╣Ар╕Ыр╣Зр╕Щ р╕Юр╕зр╕Б video or р╣Др╕Яр╕ер╣Мр╣Ар╕кр╕╡р╕вр╕З
        videoElement.onloadedmetadata = () => {
            resolve(videoElement);
        }
    })
}

// р╕кр╕гр╣Йр╕▓р╕З function loop р╣Бр╕кр╕Бр╕Щ video
async function detectFrame(video, model) {
    // р╕кр╕▒р╣Ир╕З AI р╕Хр╕гр╕зр╕Ир╕Ир╕▒р╕Ъ video р╕Ир╕▓р╕Бр╕Бр╕ер╣Йр╕нр╕Зр╕Фр╣Йр╕зр╕в
    const predictions = await model.detect(video);

    // р╕Бр╣Ир╕нр╕Щр╕Ир╕░р╕зр╕▓р╕Фр╕Бр╕гр╕нр╕Ър╣Гр╕лр╕бр╣И р╣Ар╕гр╕▓р╕Хр╣Йр╕нр╕З "р╕ер╣Йр╕▓р╕Зр╣Бр╕Ьр╣Ир╕Щр╣Гр╕к (Canvas)" р╕Бр╣Ир╕нр╕Щ р╣Др╕бр╣Ир╕Зр╕▒р╣Йр╕Щр╕Бр╕гр╕нр╕Ър╣Бр╕Фр╕Зр╕Ир╕░р╕Лр╣Йр╕нр╕Щр╕Чр╕▒р╕Ър╕Бр╕▒р╕Щр╕Ир╕Щр╣Ар╕Хр╣Зр╕бр╕Ир╕н
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // р╕зр╕▓р╕Фр╕Бр╕гр╕нр╕Ър╣Гр╕лр╕бр╣И
    let objectCount = 0; // р╕Щр╕▒р╕Ър╕Ир╕│р╕Щр╕зр╕Щр╕Чр╕╡р╣Ир╕нр╕вр╕▓р╕Бр╣Др╕Фр╣Й
    predictions.forEach(item => {
        const bbox = item.bbox;

        if (item.class === 'person') { // р╕зр╕▓р╕Фр╕Бр╕гр╕нр╕Ъ
            ctx.strokeRect(bbox[0], bbox[1], bbox[2], bbox[3]);
            objectCount += 1;
            console.log(objectCount);
            // р╣Гр╕лр╣Йр╕бр╕▒р╕Щр╕Юр╕┤р╕бр╕Юр╣Мр╕Кр╕╖р╣Ир╕нр╕Ър╕нр╕Бр╕Фр╣Йр╕зр╕вр╕зр╣Ир╕▓р╣Ар╕Ир╕нр╕нр╕░р╣Др╕г!
            ctx.fillStyle = 'red';  // р╕Бр╕│р╕лр╕Щр╕Фр╕кр╕╡р╕Хр╕▒р╕зр╕нр╕▒р╕Бр╕йр╕гр╣Ар╕Ыр╣Зр╕Щр╕кр╕╡р╣Бр╕Фр╕З
            ctx.fillText(item.class, bbox[0], bbox[1] - 5);
            //           ^^^^^^^^^   ^^^^^^   ^^^^^^^^^^^
            //           "person"    р╕Лр╣Йр╕▓р╕вр╕кр╕╕р╕Ф  р╕Ър╕Щр╕Бр╕гр╕нр╕Ър╕Вр╕╢р╣Йр╕Щр╣Др╕Ы 5px
        }


    });
    // р╕Хр╕▒р╕зр╕Щр╕▒р╕Ър╕Ир╕│р╕Щр╕зр╕Щ
    ctx.fillStyle = 'yellow';
    ctx.font = '24px Arial';
    ctx.fillText('р╕Ир╕│р╕Щр╕зр╕Щр╕Др╕Щ: ' + objectCount, 10, 30);

    currentCount = objectCount;

    // 4. р╕кр╕▒р╣Ир╕Зр╣Гр╕лр╣Йр╕зр╕Щр╕ер╕╣р╕Ыр╣Ар╕гр╕╡р╕вр╕Бр╕Хр╕▒р╕зр╣Ар╕нр╕Зр╕Лр╣Йр╕│р╣Др╕Ыр╣Ар╕гр╕╖р╣Ир╕нр╕вр╣Ж!
    requestAnimationFrame(() => {
        detectFrame(video, model)
    })

    // ==========================================
    // ЁЯМЙ р╕кр╕░р╕Юр╕▓р╕Щр╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Др╕Ыр╣Гр╕лр╣Й Backend (р╣Ар╕Лр╕┤р╕гр╣Мр╕Яр╣Ар╕зр╕нр╕гр╣М)
    // ==========================================



}

// р╕Фр╕▒р╕Бр╕гр╕н event 
// imgElement.onload = () => {
//     startAI();
// }

// ЁЯХ╡я╕ПтАНтЩВя╕П р╕Др╕│р╕Цр╕▓р╕бр╕Чр╕╡р╣И 1: р╕Щр╕▓р╕мр╕┤р╕Бр╕▓р╕Хр╕▒р╣Йр╕Зр╣Ар╕зр╕ер╕▓ (Timer)
// р╣Ар╕гр╕▓р╕Хр╣Йр╕нр╕Зр╕Бр╕▓р╕гр╣Гр╕лр╣Йр╣Вр╕Др╣Йр╕Фр╣Гр╕Щр╕Ър╕ер╣Зр╕нр╕Бр╕Щр╕╡р╣Й р╕Чр╕│р╕Зр╕▓р╕Щр╕Лр╣Йр╕│р╣Ж "р╕Чр╕╕р╕Бр╣Ж 5 р╕зр╕┤р╕Щр╕▓р╕Чр╕╡" (5000 р╕бр╕┤р╕ер╕ер╕┤р╕зр╕┤р╕Щр╕▓р╕Чр╕╡)
// р╕кр╕░р╕Юр╕▓р╕Щр╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Др╕Ыр╣Гр╕лр╣Й Backend (р╣Ар╕Лр╕┤р╕гр╣Мр╕Яр╣Ар╕зр╕нр╕гр╣М)
setInterval(() => {
    console.log('р╕Бр╕│р╕ер╕▒р╕Зр╣Ар╕Хр╕гр╕╡р╕вр╕бр╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕е: р╕Ир╕│р╕Щр╕зр╕Щр╕Др╕Щ = ', currentCount)

    // р╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕е р╕Хр╣Ир╕нр╣Др╕Ыр╕Чр╕╡р╣И backend
    // р╕кр╕▒р╣Ир╕З "fetch" (р╕Ир╣Йр╕▓р╕Зр╕Юр╕╡р╣Ир╕зр╕┤р╕Щр╕бр╕нр╣Др╕Лр╕Др╣М) р╣Гр╕лр╣Йр╕Щр╕│р╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Др╕Ыр╕кр╣Ир╕Зр╕Чр╕╡р╣Ир╕Чр╕╡р╣Ир╕нр╕вр╕╣р╣И (URL) р╕Вр╕нр╕Зр╣Ар╕Лр╕┤р╕гр╣Мр╕Яр╣Ар╕зр╕нр╕гр╣Мр╕лр╕ер╕▒р╕Зр╕Ър╣Йр╕▓р╕Щр╣Ар╕гр╕▓
    fetch('http://localhost:3000/api/qc-log', {

        // method: р╕гр╕╣р╕Ыр╣Бр╕Ър╕Ър╕Бр╕▓р╕гр╕кр╣Ир╕Зр╕Юр╕▒р╕кр╕Фр╕╕
        // р╣Гр╕Кр╣Й 'POST' р╣Ар╕Юр╕гр╕▓р╕░р╣Ар╕гр╕▓р╕Хр╣Йр╕нр╕Зр╕Бр╕▓р╕г "р╕кр╣Ир╕З" р╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Др╕Ыр╣Гр╕лр╣Йр╣Ар╕Лр╕┤р╕гр╣Мр╕Яр╣Ар╕зр╕нр╕гр╣Мр╣Ар╕Бр╣Зр╕Ъ (р╕Цр╣Йр╕▓р╣Гр╕Кр╣Й 'GET' р╕Др╕╖р╕нр╕Бр╕▓р╕гр╕Вр╕нр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕бр╕▓р╕Фр╕╣)
        method: 'POST',

        // headers: р╕Ыр╣Йр╕▓р╕вр╣Бр╕Ыр╕░р╕лр╕Щр╣Йр╕▓р╕Бр╕ер╣Ир╕нр╕Зр╕Юр╕▒р╕кр╕Фр╕╕
        // р╣Ар╕Юр╕╖р╣Ир╕нр╕Ър╕нр╕Бр╕Юр╕Щр╕▒р╕Бр╕Зр╕▓р╕Щр╕гр╕▒р╕Ър╕Вр╕нр╕З (р╣Ар╕Лр╕┤р╕гр╣Мр╕Яр╣Ар╕зр╕нр╕гр╣М) р╕зр╣Ир╕▓р╕Вр╕нр╕Зр╕Вр╣Йр╕▓р╕Зр╣Гр╕Щр╣Ар╕Ыр╣Зр╕Щр╕нр╕░р╣Др╕г р╕Ир╕░р╣Др╕Фр╣Йр╣Бр╕Бр╕░р╕Цр╕╣р╕Бр╕зр╕┤р╕Шр╕╡
        headers: {
            // р╕Ър╕нр╕Бр╕зр╣Ир╕▓р╣Ар╕Щр╕╖р╣Йр╕нр╕лр╕▓р╕Вр╣Йр╕▓р╕Зр╣Гр╕Щр╕Цр╕╣р╕Бр╣Ар╕Вр╕╡р╕вр╕Щр╕Фр╣Йр╕зр╕вр╕ар╕▓р╕йр╕▓ JSON (р╕бр╕▓р╕Хр╕гр╕Рр╕▓р╕Щр╕Бр╕▓р╕гр╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Вр╣Йр╕▓р╕бр╣Ар╕Щр╣Зр╕Х)
            'Content-Type': 'application/json'
        },

        // body: р╕Хр╕▒р╕зр╕кр╕┤р╣Ир╕Зр╕Вр╕нр╕Зр╕Чр╕╡р╣Ир╕нр╕вр╕╣р╣Ир╕Вр╣Йр╕▓р╕Зр╣Гр╕Щр╕Бр╕ер╣Ир╕нр╕Зр╕Юр╕▒р╕кр╕Фр╕╕ (р╣Ар╕Щр╕╖р╣Йр╕нр╕лр╕▓р╕Чр╕╡р╣Ир╣Ар╕гр╕▓р╕Ир╕░р╕кр╣Ир╕З)
        // р╕Хр╣Йр╕нр╕Зр╣Гр╕Кр╣Й JSON.stringify() р╣Ар╕Юр╕╖р╣Ир╕нр╣Бр╕Ыр╕ер╕З "Object р╕Вр╕нр╕З JavaScript" р╣Гр╕лр╣Йр╕Бр╕ер╕▓р╕вр╣Ар╕Ыр╣Зр╕Щ "р╕Вр╣Йр╕нр╕Др╕зр╕▓р╕б (String)" р╕Бр╣Ир╕нр╕Щ р╣Ар╕Юр╕гр╕▓р╕░р╕кр╕▓р╕вр╣Бр╕ер╕Щр╕нр╕┤р╕Щр╣Ар╕Чр╕нр╕гр╣Мр╣Ар╕Щр╣Зр╕Хр╕кр╣Ир╕Зр╣Др╕Фр╣Йр╣Бр╕Др╣Ир╕Хр╕▒р╕зр╕лр╕Щр╕▒р╕Зр╕кр╕╖р╕н
        body: JSON.stringify({
            count: currentCount,        // р╕Ир╕│р╕Щр╕зр╕Щр╕Др╕Щр╕Чр╕╡р╣Ир╕Щр╕▒р╕Ър╣Др╕Фр╣Йр╕Ир╕▓р╕Бр╕ер╕╣р╕Ы AI 
            detectedClass: 'person',   // р╕Ър╕нр╕Бр╣Ар╕Лр╕┤р╕гр╣Мр╕Яр╣Ар╕зр╕нр╕гр╣Мр╕зр╣Ир╕▓р╕Хр╕▒р╕зр╣Ар╕ер╕Вр╕Щр╕╡р╣Йр╕Др╕╖р╕нр╕Ир╕│р╕Щр╕зр╕Щр╕Вр╕нр╕Зр╕нр╕░р╣Др╕г (р╕Хр╕нр╕Щр╕Щр╕╡р╣Йр╕Др╕╖р╕нр╕Др╕Щ)
            timestamp: new Date()      // р╕Ыр╕гр╕░р╕Чр╕▒р╕Ър╕Хр╕гр╕▓р╣Ар╕зр╕ер╕▓р╕Ыр╕▒р╕Ир╕Ир╕╕р╕Ър╕▒р╕Щ р╕У р╕зр╕┤р╕Щр╕▓р╕Чр╕╡р╕Чр╕╡р╣Ир╕кр╣Ир╕З
        })
    })
        // .then() р╕Хр╕▒р╕зр╕Чр╕╡р╣И 1: р╕Фр╣Ир╕▓р╕Щр╕гр╕▒р╕Ър╕Вр╕нр╕З
        // р╣Ар╕бр╕╖р╣Ир╕нр╣Ар╕Лр╕┤р╕гр╣Мр╕Яр╣Ар╕зр╕нр╕гр╣Мр╕Хр╕нр╕Ър╕Бр╕ер╕▒р╕Ър╕бр╕▓ (response) р╣Ар╕гр╕▓р╕Ир╕░р╣Бр╕Ыр╕ер╕Зр╕Др╕│р╕Хр╕нр╕Ър╕Щр╕▒р╣Йр╕Щр╕Ир╕▓р╕Бр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕б JSON р╣Гр╕лр╣Йр╕Бр╕ер╕▒р╕Ър╕бр╕▓р╣Ар╕Ыр╣Зр╕Щ Object JavaScript р╣Ар╕Юр╕╖р╣Ир╕нр╣Гр╕лр╣Йр╕лр╕Щр╣Йр╕▓р╕Ър╣Йр╕▓р╕Щр╕нр╣Ир╕▓р╕Щр╕гр╕╣р╣Йр╣Ар╕гр╕╖р╣Ир╕нр╕З
        .then(response => response.json())

        // .then() р╕Хр╕▒р╕зр╕Чр╕╡р╣И 2: р╕Фр╣Ир╕▓р╕Щр╣Ар╕Ыр╕┤р╕Фр╕нр╣Ир╕▓р╕Щр╕Ир╕Фр╕лр╕бр╕▓р╕вр╕Хр╕нр╕Ър╕Бр╕ер╕▒р╕Ъ
        // р╣Ар╕нр╕▓р╕Др╕│р╕Хр╕нр╕Ър╕Чр╕╡р╣Ир╣Бр╕Ыр╕ер╕Зр╣Ар╕кр╕гр╣Зр╕Ир╣Бр╕ер╣Йр╕з (data) р╕бр╕▓р╕Ыр╕гр╕┤р╕Щр╕Хр╣Мр╣Вр╕Кр╕зр╣Мр╣Гр╕Щ Console р╕зр╣Ир╕▓р╣Ар╕Лр╕┤р╕гр╣Мр╕Яр╣Ар╕зр╕нр╕гр╣Мр╕Юр╕╣р╕Фр╕зр╣Ир╕▓р╕нр╕░р╣Др╕г
        .then(data => console.log('тЬЕ р╕лр╕ер╕▒р╕Зр╕Ър╣Йр╕▓р╕Щр╕Хр╕нр╕Ър╕Бр╕ер╕▒р╕Ър╕бр╕▓р╕зр╣Ир╕▓: ', data))

        // .catch(): р╕Фр╣Ир╕▓р╕Щр╕Фр╕▒р╕Бр╕Ир╕▒р╕Ър╕нр╕╕р╕Ър╕▒р╕Хр╕┤р╣Ар╕лр╕Хр╕╕
        // р╕Цр╣Йр╕▓р╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Фр╕гр╕░р╕лр╕зр╣Ир╕▓р╕Зр╕Чр╕▓р╕З (р╣Ар╕Кр╣Ир╕Щ р╣Ар╕Лр╕┤р╕гр╣Мр╕Яр╣Ар╕зр╕нр╕гр╣Мр╕Ыр╕┤р╕Фр╕нр╕вр╕╣р╣И, р╣Ар╕Щр╣Зр╕Хр╕лр╕ер╕╕р╕Ф) р╕бр╕▒р╕Щр╕Ир╕░р╣Др╕бр╣Ир╕Чр╕│р╣Гр╕лр╣Йр╣Ар╕зр╣Зр╕Ър╕Юр╕▒р╕З р╣Бр╕Хр╣Ир╕Ир╕░р╣Ар╕Фр╣Йр╕Зр╕бр╕▓р╕Чр╕│р╕Зр╕▓р╕Щр╕Хр╕гр╕Зр╕Щр╕╡р╣Йр╣Бр╕Чр╕Щр╣Ар╕Юр╕╖р╣Ир╕нр╕Ыр╕гр╕┤р╕Щр╕Хр╣М Error р╕кр╕╡р╣Бр╕Фр╕Зр╕Ър╕нр╕Бр╣Ар╕гр╕▓
        .catch(error => console.error('тЭМ р╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Др╕бр╣Ир╕кр╕│р╣Ар╕гр╣Зр╕И: ', error));
}, 5000)

startAI();

